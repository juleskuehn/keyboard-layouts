# Layouts, as tersely as possible: no grave, tilde, slash, bar, special keys

qwerty = [
	[['1','!'],['2','@'],['3','#'],['4','$'],['5','%'],['6','^'],['7','&'],['8','*'],['9','('],['0',')'],['-','_'],['=','+']]
	['q','w','e','r','t','y','u','i','o','p',['[','{'],[']','}']]
	['a','s','d','f','g','h','j','k','l',[';',':'],['\'','"']]
	['z','x','c','v','b','n','m',[',','<'],['.','>'],['/','?']]
]
azerty = [
	[['&','1'],['é','2'],['"','3'],['\'','4'],['(','5'],['-','6'],['è','7'],['_','8'],['ç','9'],['à','0'],[')','°'],['=','+']]
	['a','z','e','r','t','y','u','i','o','p',['^','¨'],['$','£']]
	['q','s','d','f','g','h','j','k','l','m',['ù','%']]
	['w','x','c','v','b','n',[',','?'],[';','.'],[':','/'],['!','§']]
]
colemak = [
	[['1','!'],['2','@'],['3','#'],['4','$'],['5','%'],['6','^'],['7','&'],['8','*'],['9','('],['0',')'],['-','_'],['=','+']]
	['q','w','f','p','g','j','l','u','y',[';',':'],['[','{'],[']','}']]
	['a','r','s','t','d','h','n','e','i','o',['\'','"']]
	['z','x','c','v','b','k','m',[',','<'],['.','>'],['/','?']]
]
dvorak = [
	[['1','!'],['2','@'],['3','#'],['4','$'],['5','%'],['6','^'],['7','&'],['8','*'],['9','('],['0',')'],['[','{'],[']','}']]
	[['\'','"'],[',','<'],['.','>'],'p','y','f','g','c','r','l',['/','?'],['=','+']]
	['a','o','e','u','i','d','h','t','n','s',['-','_']]
	[[';',':'],'q','j','k','x','b','m','w','v','z']
]
pdvorak = [
	[['&','%'],['[','7'],['{','5'],['}','3'],['(','1'],['=','9'],['*','0'],[')','2'],['+','4'],[']','6'],['!','8'],['#','`']]
	[[';',':'],[',','<'],['.','>'],'p','y','f','g','c','r','l',['/','?'],['@','^']]
	['a','o','e','u','i','d','h','t','n','s',['-','_']]
	[['\'','"'],'q','j','k','x','b','m','w','v','z']
]
workman = [
	[['1','!'],['2','@'],['3','#'],['4','$'],['5','%'],['6','^'],['7','&'],['8','*'],['9','('],['0',')'],['-','_'],['=','+']]
	['q','d','r','w','b','j','f','u','p',[';',':'],['[','{'],[']','}']]
	['a','s','h','t','g','y','n','e','o','i',['\'','"']]
	['z','x','m','c','v','k','l',[',','<'],['.','>'],['/','?']]
]
norman = [
	[['1','!'],['2','@'],['3','#'],['4','$'],['5','%'],['6','^'],['7','&'],['8','*'],['9','('],['0',')'],['-','_'],['=','+']]
	['q','w','d','f','k','j','u','r','l',[';',':'],['[','{'],[']','}']]
	['a','s','e','t','g','y','n','i','o','h',['\'','"']]
	['z','x','c','v','b','p','m',[',','<'],['.','>'],['/','?']]
]
bepo = [
	[['"','1'],['«','2'],['»','3'],['(','4'],[')','5'],['@','6'],['+','7'],['-','8'],['/','9'],['*','0'],['=','°'],['%','`']]
	['b',['é','É'],'p','o',['è','È'],['^','!'],'v','d','l','j','z','w']
	['a','u','i','e',[',',';'],'c','t','s','r','n','m']
	[['à','À'],'y','x',['.',':'],'k',['\'','?'],'q','g','h','f']
]
arensito = [
	[['1','!'],['2','@'],['3','#'],['4','$'],['5','%'],['6','^'],['7','&'],['8','*'],['9','('],['0',')'],['/','?'],['=','+']]
	['q','l',[',','<'],'p',['\'','"'],[';',':'],'f','u','d','k',['[','{'],[']','}']]
	['a','r','e','n','b','g','s','i','t','o',['-','_']]
	['z','w',['.','>'],'h','j','v','c','y','m','x']
]
qwpr = [
	[['1','!'],['2','@'],['3','#'],['4','$'],['5','%'],['6','^'],['7','&'],['8','*'],['9','('],['0',')'],['-','_'],['=','+']]
	['q','w','p','r','f','y','u','k','l',[';',':'],['[','{'],[']','}']]
	['a','s','d','t','g','h','n','i','o','e',['\'','"']]
	['z','x','c','v','b','j','m',[',','<'],['.','>'],['/','?']]
]
asset = [
	[['1','!'],['2','@'],['3','#'],['4','$'],['5','%'],['6','^'],['7','&'],['8','*'],['9','('],['0',')'],['-','_'],['=','+']]
	['q','w','j','f','g','y','p','u','l',[';',':'],['[','{'],[']','}']]
	['a','s','e','t','d','h','n','i','o','r',['\'','"']]
	['z','x','c','v','b','k','m',[',','<'],['.','>'],['/','?']]
]
mtgap2 = [
	[['1','!'],['2','@'],['3','#'],['4','$'],['5','%'],['6','^'],['7','&'],['8','*'],['9','<'],['0','>'],['-','_'],['=','+']]
	[[',','('],'f','h','d','k','j','c','u','l',['.',')'],['[','{'],[']','}']]
	['o','a','n','t','g','m','s','e','r','i',['/','?']]
	['q','x','b','p','z','y','w',['\'','"'],'v',[';',':']]
]
klausler = [
	[['1','!'],['2','@'],['3','#'],['4','$'],['5','%'],['6','^'],['7','&'],['8','*'],['9','('],['0',')'],['-','_'],['=','+']]
	['k',[',','<'],'u','y','p','w','l','m','f','c',['[','{'],[']','}']]
	['o','a','e','i','d','r','n','t','h','s',['/','?']]
	['q',['.','>'],['\'','"'],[';',':'],'z','x','v','g','b','j']
]
cqwerf = [
	[['1','!'],['2','@'],['3','#'],['4','$'],['5','%'],['6','^'],['7','&'],['8','*'],['9','('],['0',')'],['-','_'],['=','+']]
	['q','w','e','r','f','j','y','l','k',[';',':'],['[','{'],[']','}']]
	['a','s','d','t','g','h','u','o','i','p',['\'','"']]
	['z','x','c','v','b','n','m',[',','<'],['.','>'],['/','?']]
]
cdvorak = [
	[['1','!'],['2','@'],['3','#'],['4','$'],['5','%'],['6','^'],['7','&'],['8','*'],['9','('],['0',')'],['[','{'],[']','}']]
	[['\'','"'],[',','<'],['.','>'],'p','y','q','f','g','r','k',['/','?'],['=','+']]
	['o','a','e','i','u','d','h','t','n','s',['-','_']]
	['z','x','c','v','j','l','m','w','b',[';',':']]
]
capewell = [
	[['1','!'],['2','@'],['3','#'],['4','$'],['5','%'],['6','^'],['7','&'],['8','*'],['9','('],['0',')'],['[','{'],[']','}']]
	[['.','>'],'y','w','d','f','j','p','l','u','q',['/','?'],['=','+']]
	['a','e','r','s','g','b','t','n','i','o',['-','_']]
	['x','z','c','v',[';',':'],'k','m','h',[',','<'],['\'','"']]
]
minimak4 = [
	[['1','!'],['2','@'],['3','#'],['4','$'],['5','%'],['6','^'],['7','&'],['8','*'],['9','('],['0',')'],['-','_'],['=','+']]
	['q','w','d','r','k','y','u','i','o','p',['[','{'],[']','}']]
	['a','s','t','f','g','h','j','e','l',[';',':'],['\'','"']]
	['z','x','c','v','b','n','m',[',','<'],['.','>'],['/','?']]
]
minimak8 = [
	[['1','!'],['2','@'],['3','#'],['4','$'],['5','%'],['6','^'],['7','&'],['8','*'],['9','('],['0',')'],['-','_'],['=','+']]
	['q','w','d','r','k','y','u','i','l','p',['[','{'],[']','}']]
	['a','s','t','f','g','h','n','e','o',[';',':'],['\'','"']]
	['z','x','c','v','b','j','m',[',','<'],['.','>'],['/','?']]
]
minimak12 = [
	[['1','!'],['2','@'],['3','#'],['4','$'],['5','%'],['6','^'],['7','&'],['8','*'],['9','('],['0',')'],['-','_'],['=','+']]
	['q','w','d','f','k','y','u','i','l',[';',':'],['[','{'],[']','}']]
	['a','s','t','r','g','h','n','e','o','p',['\'','"']]
	['z','x','c','v','b','j','m',[',','<'],['.','>'],['/','?']]
]
tarmak1 = [
	[['1','!'],['2','@'],['3','#'],['4','$'],['5','%'],['6','^'],['7','&'],['8','*'],['9','('],['0',')'],['-','_'],['=','+']]
	['q','w','j','r','t','y','u','i','o','p',['[','{'],[']','}']]
	['a','s','d','f','g','h','n','e','l',[';',':'],['\'','"']]
	['z','x','c','v','b','k','m',[',','<'],['.','>'],['/','?']]
]
tarmak2 = [
	[['1','!'],['2','@'],['3','#'],['4','$'],['5','%'],['6','^'],['7','&'],['8','*'],['9','('],['0',')'],['-','_'],['=','+']]
	['q','w','f','r','g','y','u','i','o','p',['[','{'],[']','}']]
	['a','s','d','t','j','h','n','e','l',[';',':'],['\'','"']]
	['z','x','c','v','b','k','m',[',','<'],['.','>'],['/','?']]
]
tarmak3 = [
	[['1','!'],['2','@'],['3','#'],['4','$'],['5','%'],['6','^'],['7','&'],['8','*'],['9','('],['0',')'],['-','_'],['=','+']]
	['q','w','f','j','g','y','u','i','o','p',['[','{'],[']','}']]
	['a','r','s','t','d','h','n','e','l',[';',':'],['\'','"']]
	['z','x','c','v','b','k','m',[',','<'],['.','>'],['/','?']]
]
tarmak4 = [
	[['1','!'],['2','@'],['3','#'],['4','$'],['5','%'],['6','^'],['7','&'],['8','*'],['9','('],['0',')'],['-','_'],['=','+']]
	['q','w','f','p','g','j','u','i','y',[';',':'],['[','{'],[']','}']]
	['a','r','s','t','d','h','n','e','l','o',['\'','"']]
	['z','x','c','v','b','k','m',[',','<'],['.','>'],['/','?']]
]
qfmlwy = [
	[['1','!'],['2','@'],['3','#'],['4','$'],['5','%'],['6','^'],['7','&'],['8','*'],['9','('],['0',')'],['-','_'],['=','+']]
	['q','f','m','l','w','y','u','o','b','j',['[','{'],[']','}']]
	['d','s','t','n','r','i','a','e','h',[';',':'],['\'','"']]
	['z','v','g','c','x','p','k',[',','<'],['.','>'],['/','?']]
]
qgmlwb = [
	[['1','!'],['2','@'],['3','#'],['4','$'],['5','%'],['6','^'],['7','&'],['8','*'],['9','('],['0',')'],['-','_'],['=','+']]
	['q','g','m','l','w','b','y','u','v',[';',':'],['[','{'],[']','}']]
	['d','s','t','n','r','i','a','e','o','h',['\'','"']]
	['z','x','c','f','j','k','p',[',','<'],['.','>'],['/','?']]
]
qgmlwy = [
	[['1','!'],['2','@'],['3','#'],['4','$'],['5','%'],['6','^'],['7','&'],['8','*'],['9','('],['0',')'],['-','_'],['=','+']]
	['q','g','m','l','w','y','f','u','b',[';',':'],['[','{'],[']','}']]
	['d','s','t','n','r','i','a','e','o','h',['\'','"']]
	['z','x','c','v','j','k','p',[',','<'],['.','>'],['/','?']]
]
qwkrfy = [
	[['1','!'],['2','@'],['3','#'],['4','$'],['5','%'],['6','^'],['7','&'],['8','*'],['9','('],['0',')'],['-','_'],['=','+']]
	['q','w','k','r','f','y','u','i','j','p',['[','{'],[']','}']]
	['d','s','a','t','n','h','o','e','l',[';',':'],['\'','"']]
	['z','x','c','v','b','g','m',[',','<'],['.','>'],['/','?']]
]
qwyrfm = [
	[['1','!'],['2','@'],['3','#'],['4','$'],['5','%'],['6','^'],['7','&'],['8','*'],['9','('],['0',')'],['-','_'],['=','+']]
	['q','w','y','r','f','m','l','u','b','p',['[','{'],[']','}']]
	['d','s','a','t','n','h','o','e','i',[';',':'],['\'','"']]
	['z','x','c','v','j','g','k',[',','<'],['.','>'],['/','?']]
]
carpalxq = [
	[['1','!'],['2','@'],['3','#'],['4','$'],['5','%'],['6','^'],['7','&'],['8','*'],['9','('],['0',')'],['-','_'],['=','+']]
	['q','w','k','r','f','y','u','l','p',[';',':'],['[','{'],[']','}']]
	['a','s','d','t','g','h','n','e','i','o',['\'','"']]
	['z','x','c','v','b','j','m',[',','<'],['.','>'],['/','?']]
]
tnwmlc = [
	[['1','!'],['2','@'],['3','#'],['4','$'],['5','%'],['6','^'],['7','&'],['8','*'],['9','('],['0',')'],['-','_'],['=','+']]
	['t','n','w','m','l','c','b','p','r','h',['[','{'],[']','}']]
	['s','g','x','j','f','k','q','z','v',[';',':'],['\'','"']]
	['e','a','d','i','o','y','u',[',','<'],['.','>'],['/','?']]
]

# Set defaults
source = eval($('#source').val())
target = eval($('#target').val())
firstTry = true

# Generate on screen keyboard HTML
genKB = (layout) ->
	keyboard = ''
	for row, r in layout
		newRow = '<div class="row" id="row'+r+'">'
		for key, k in row
			newRow += '<div class="key" id="key'+r+'-'+k+'"><div class="keyinner">'
			if typeof key is 'string'
				newRow += '<div class="label">' + key.toUpperCase() + '</div>'
			else for label, l in key
				newRow += '<div class="label layer'+l+'">' + label + '</div>'
			# add homing 'ridges' to (qwerty) F and J keys
			if r is 2 and (k is 3 or k is 6)
				newRow += '<div class="homing"></div>'
			newRow += '</div></div>'
		newRow += '</div>'
		keyboard += newRow
	return keyboard

# Initiate Keypress.js
kp = new window.keypress.Listener()

# Initiate sendkeys
sendkeys = (element,keys) ->
	keys = keys.replace(/([^{])\n/g, '$1{enter}') # turn line feeds into explicit break insertions, but not if escaped
	bililiteRange(element).bounds('selection').sendkeys(keys).select()
	element.focus()

# Track whether shift is pressed
shiftPressed = false

# Track lower shelf special characters
lowerShelf = []

# Generate bindings with Keypress.js
bind = (source,target) ->
	kp.reset()
	lowerShelf = []
	for row, r in source
		for key, k in row
			do (key,target,r,k) ->
				targetKey = target[r][k]
				keyLower =
					on_keyup : ->
						$('#key'+r+'-'+k).removeClass('pressed')
					is_exclusive: true
				keyUpper =
					on_keyup : ->
						$('#key'+r+'-'+k).removeClass('pressed')
					prevent_default: true
				if typeof key is 'string' # alpha source
					keyLower.keys = key
					keyUpper.keys = 'shift '+key
				else
					keyLower.keys = key[0]
					keyUpper.keys = key[1]
				if typeof targetKey is 'string' # alpha target
					keyLower.on_keydown = ->
						$('#key'+r+'-'+k).addClass('pressed')
						keyPress(targetKey)
					keyUpper.on_keydown = ->
						$('#key'+r+'-'+k).addClass('pressed')
						keyPress(targetKey.toUpperCase())
				else
					lowerShelf += targetKey[0]
					keyLower.on_keydown = ->
						$('#key'+r+'-'+k).addClass('pressed')
						keyPress(targetKey[0])
					keyUpper.on_keydown = ->
						$('#key'+r+'-'+k).addClass('pressed')
						keyPress(targetKey[1])
				kp.register_many([keyLower,keyUpper])
	# track shift
	shift =
		keys: 'shift'
		on_keyup: ->
			shiftPressed = false
		on_keydown: ->
			shiftPressed = true
		prevent_default: true
	kp.register_combo(shift)
	return

# Emulate keypress to the textarea
keyPress = (key) ->
	# Clear instruction text first
	text = $('#textarea')
	if firstTry
		text.html('')
		firstTry = false
	# Write the character to textarea
	if shiftPressed and ( key.match(/^[a-z]+$/) or key in lowerShelf )
		return # to prevent Aa Bb Cc bug
	else
		sendkeys(document.getElementById('textarea'),key)

# Inject initial keyboard into DOM
$('#keyboard').html(genKB(target))
bind(source,target)

# Monitor dropdowns for changes and apply
$('#target').change(->
	target = eval($(this).val())
	$('#keyboard').html(genKB(target))
	bind(source,target)
)
$('#source').change(->
	source = eval($(this).val())
	bind(source,target)
)
